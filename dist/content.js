(()=>{"use strict";const t=["left","center","right"],e=["small","medium","large"],i={small:18,medium:22,large:26};function s(e){return t.includes(e)?e:"center"}function n(t){return e.includes(t)?t:"medium"}const a={en:"Loading...","zh-CN":"加载中...","zh-TW":"載入中..."};function l(t){return"zh-CN"===t||"zh-TW"===t?t:"en"}class o{constructor(){this.cache=new Map,this.maxSize=500,this.ttl=864e5}getKey(t,e,i){return`${t}:${e}:${this.normalize(i)}`}normalize(t){return t.trim().toLowerCase().replace(/\s+/g," ")}get(t,e,i){const s=this.getKey(t,e,i),n=this.cache.get(s);return n?Date.now()-n.timestamp>this.ttl?(this.cache.delete(s),null):n.text:null}set(t,e,i,s){const n=this.getKey(t,e,i);if(this.cache.size>=this.maxSize){const t=this.cache.keys().next().value;t&&this.cache.delete(t)}this.cache.set(n,{text:s,timestamp:Date.now()})}clear(){this.cache.clear()}}class r{constructor(){this.state={enabled:!0,targetLang:"zh-CN",showOriginal:!1,hideOriginalSubtitles:!1,textAlign:"center",translatedFontSize:"medium"},this.wrapper=null,this.overlay=null,this.subtitleBox=null,this.loadingLine=null,this.originalLine=null,this.translatedLine=null,this.currentSubtitle=null,this.lastOriginalText="",this.debounceTimer=null,this.DEBOUNCE_DELAY=180,this.lastProcessTime=0,this.THROTTLE_DELAY=60,this.lastTranslatedText="",this.seq=0,this.latestSeq=0,this.lastValidSubtitleTime=0,this.SUBTITLE_TIMEOUT=3e3,this.isDragging=!1,this.isClosed=!1,this.dragOffsetX=0,this.dragOffsetY=0,this.position={bottom:120,left:0},this.overlayWidth=800,this.useDefaultPosition=!0,this.observer=null,this.checkInterval=null,this.subtitleObserver=null,this.isVideoPaused=!1,this.isAdPlaying=!1,this.adCheckInterval=null,this.uiLanguage="en",this.createOverlayAttempts=0,this.cache=new o,this.translationQueue=new Set,this.TRANSLATION_INTERVAL=500,this.handleMouseMove=t=>{if(!this.isDragging||!this.overlay)return;const e=this.overlay.parentElement;if(!e)return;const i=e.getBoundingClientRect();let s=t.clientX-i.left-this.dragOffsetX,n=i.bottom-t.clientY-this.dragOffsetY;const a=i.width-this.overlayWidth,l=i.height-50;this.position.left=Math.max(0,Math.min(s,a)),this.position.bottom=Math.max(20,Math.min(n,l)),this.updateOverlayPosition()},this.handleMouseUp=()=>{this.isDragging&&(this.isDragging=!1,this.savePosition(),console.log("[YouTube Live Translate] 拖拽结束，位置已保存:",this.position),this.subtitleBox&&(this.subtitleBox.style.cursor="grab")),document.removeEventListener("mousemove",this.handleMouseMove),document.removeEventListener("mouseup",this.handleMouseUp)},this.init()}async init(){console.log("[YouTube Live Translate] 初始化中...");const t=await chrome.storage.sync.get(["enabled","targetLang","showOriginal","hideOriginalSubtitles","textAlign","translatedFontSize","position","isClosed","uiLanguage"]);this.uiLanguage=l(t.uiLanguage),this.state={enabled:t.enabled??!0,targetLang:t.targetLang??"zh-CN",showOriginal:t.showOriginal??!1,hideOriginalSubtitles:t.hideOriginalSubtitles??!1,textAlign:s(t.textAlign),translatedFontSize:n(t.translatedFontSize)};const e=t.position;e&&"number"==typeof e.left&&"number"==typeof e.bottom&&(0===e.left&&120===e.bottom||(this.position=e,this.useDefaultPosition=!1)),this.isClosed=t.isClosed??!1,console.log("[YouTube Live Translate] 设置:",this.state),console.log("[YouTube Live Translate] 位置:",this.position),console.log("[YouTube Live Translate] 关闭状态:",this.isClosed),this.updateOriginalSubtitlesVisibility(),chrome.storage.onChanged.addListener((t,e)=>{"sync"===e&&(t.uiLanguage&&(this.uiLanguage=l(t.uiLanguage.newValue),this.updateLoadingText()),t.enabled&&(this.state.enabled=t.enabled.newValue,this.toggleTranslation()),t.targetLang&&(this.state.targetLang=t.targetLang.newValue,this.cache.clear()),t.showOriginal&&(this.state.showOriginal=t.showOriginal.newValue,this.updateOriginalVisibility()),t.hideOriginalSubtitles&&(this.state.hideOriginalSubtitles=t.hideOriginalSubtitles.newValue,this.updateOriginalSubtitlesVisibility()),t.textAlign&&(this.state.textAlign=s(t.textAlign.newValue),this.updateTextAlign()),t.translatedFontSize&&(this.state.translatedFontSize=n(t.translatedFontSize.newValue),this.updateTranslatedFontSize()))}),this.setupVideoPauseDetection(),this.setupAdDetection(),this.setupKeyboardShortcuts(),this.createOverlay(),this.startWatchingSubtitles()}setupVideoPauseDetection(){const t=()=>{const e=document.querySelector("video");e?(console.log("[YouTube Live Translate] 找到视频元素"),e.addEventListener("pause",()=>{console.log("[YouTube Live Translate] 视频暂停"),this.isVideoPaused=!0}),e.addEventListener("play",()=>{console.log("[YouTube Live Translate] 视频播放"),this.isVideoPaused=!1}),this.isVideoPaused=e.paused):setTimeout(t,1e3)};t()}setupAdDetection(){console.log("[YouTube Live Translate] 初始化广告检测...");const t=()=>{const t=[".ytp-ad-player-overlay",".ytp-ad-preview-image",".ytp-ad-badge",".ytp-ad-skip-button",".ytp-ad-text",".ytp-ad-progress"];let e=!1;for(const i of t){const t=document.querySelector(i);if(t&&null!==t.offsetParent){e=!0;break}}const i=document.querySelector("#movie_player");if(i){const t=i.classList;(t.contains("ad-showing")||t.contains("ad-interrupting"))&&(e=!0)}e&&!this.isAdPlaying?(console.log("[YouTube Live Translate] 检测到广告开始，隐藏字幕"),this.isAdPlaying=!0,this.overlay&&(this.overlay.style.display="none")):!e&&this.isAdPlaying&&(console.log("[YouTube Live Translate] 广告结束，显示字幕"),this.isAdPlaying=!1,this.overlay&&!this.isClosed&&(this.overlay.style.display="block"),this.updateOriginalSubtitlesVisibility())};this.adCheckInterval=window.setInterval(t,1e3),t()}isShortcutModifier(t){return t.altKey||t.metaKey}setupKeyboardShortcuts(){document.addEventListener("keydown",t=>{const e=t.key.toLowerCase();this.isShortcutModifier(t)&&"e"===e&&(t.preventDefault(),this.state.enabled=!this.state.enabled,chrome.storage.sync.set({enabled:this.state.enabled}),this.toggleTranslation(),this.state.enabled&&!this.isClosed&&this.overlay&&(this.overlay.style.display="block"),console.log("[YouTube Live Translate] 翻译",this.state.enabled?"已开启":"已关闭"))})}findPlayer(){let t=document.querySelector("#movie_player");if(t)return t;const e=document.querySelector("ytd-player");return e?.shadowRoot&&(t=e.shadowRoot.querySelector("#movie_player"),t)?t:document.querySelector("ytd-player")||null}createOverlay(){if(this.overlay)return;const t=this.findPlayer();if(!t)return this.createOverlayAttempts+=1,this.createOverlayAttempts>=r.MAX_OVERLAY_ATTEMPTS?void console.error("[YouTube Live Translate] 多次未找到播放器，停止重试"):(console.warn("[YouTube Live Translate] 未找到播放器，2 秒后重试"),void setTimeout(()=>this.createOverlay(),2e3));const e=t;"static"===window.getComputedStyle(e).position&&(e.style.position="relative");const s=document.createElement("div");this.wrapper=s,s.id="yt-live-translate-wrapper",s.style.cssText="\n      position: absolute;\n      left: 0;\n      top: 0;\n      width: 100%;\n      height: 100%;\n      pointer-events: none;\n      z-index: 9998;\n    ",this.overlay=document.createElement("div"),this.overlay.id="yt-live-translate-overlay",this.overlay.style.cssText=`\n      width: ${this.overlayWidth}px;\n      height: auto;\n      z-index: 9999;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;\n      pointer-events: none;\n      position: absolute;\n      display: none;\n    `,this.updateOverlayPosition(),this.subtitleBox=document.createElement("div"),this.subtitleBox.id="yt-live-translate-box",this.subtitleBox.style.cssText="\n      background: rgba(0, 0, 0, 0.6);\n      padding: 12px 20px;\n      padding-top: 8px;\n      border-radius: 0;\n      display: flex;\n      flex-direction: column;\n      gap: 4px;\n      pointer-events: auto;\n      position: relative;\n      cursor: grab;\n      max-height: 50vh;\n      overflow: hidden;\n    ",this.subtitleBox.addEventListener("mousedown",t=>this.handleMouseDown(t)),this.loadingLine=document.createElement("div"),this.loadingLine.id="yt-live-translate-loading",this.loadingLine.setAttribute("aria-hidden","true"),this.loadingLine.style.cssText="\n      display: none;\n      align-items: center;\n      justify-content: center;\n      gap: 8px;\n      color: rgba(255, 255, 255, 0.8);\n      font-size: 16px;\n      pointer-events: none;\n    ";const n=document.createElement("span");n.style.cssText="\n      display: inline-block;\n      width: 18px;\n      height: 18px;\n      border: 2px solid rgba(255, 255, 255, 0.3);\n      border-top-color: white;\n      border-radius: 50%;\n      animation: yt-live-translate-spin 0.7s linear infinite;\n    ";const l=document.createElement("span");l.className="yt-live-translate-loading-text",l.textContent=a[this.uiLanguage],this.loadingLine.appendChild(n),this.loadingLine.appendChild(l),this.injectLoadingStyles(),this.subtitleBox.appendChild(this.loadingLine),this.originalLine=document.createElement("div"),this.originalLine.id="yt-live-translate-original",this.originalLine.style.cssText=`\n      color: rgba(255, 255, 255, 0.6);\n      font-size: 18px;\n      line-height: 1.4;\n      text-align: ${this.state.textAlign};\n      white-space: pre-wrap;\n      word-wrap: break-word;\n      display: ${this.state.showOriginal?"-webkit-box":"none"};\n      -webkit-line-clamp: 2;\n      -webkit-box-orient: vertical;\n      overflow: hidden;\n      text-overflow: ellipsis;\n      pointer-events: none;\n      user-select: none;\n    `;const o=i[this.state.translatedFontSize];this.translatedLine=document.createElement("div"),this.translatedLine.id="yt-live-translate-translated",this.translatedLine.style.cssText=`\n      color: white;\n      font-size: ${o}px;\n      line-height: 1.4;\n      font-weight: 500;\n      text-align: ${this.state.textAlign};\n      white-space: pre-wrap;\n      word-wrap: break-word;\n      pointer-events: none;\n      user-select: none;\n      display: block;\n    `,this.subtitleBox.appendChild(this.originalLine),this.subtitleBox.appendChild(this.translatedLine),this.overlay.appendChild(this.subtitleBox),s.appendChild(this.overlay),t.appendChild(s),console.log("[YouTube Live Translate] Overlay 已创建，默认居中:",this.useDefaultPosition)}injectLoadingStyles(){if(document.getElementById("yt-live-translate-loading-styles"))return;const t=document.createElement("style");t.id="yt-live-translate-loading-styles",t.textContent="\n      @keyframes yt-live-translate-spin {\n        to { transform: rotate(360deg); }\n      }\n    ",(document.head||document.documentElement).appendChild(t)}showLoading(){this.loadingLine&&(this.loadingLine.style.display="flex")}hideLoading(){this.loadingLine&&(this.loadingLine.style.display="none")}updateLoadingText(){if(!this.loadingLine)return;const t=this.loadingLine.querySelector(".yt-live-translate-loading-text");t&&(t.textContent=a[this.uiLanguage])}updateOverlayPosition(){this.overlay&&(this.useDefaultPosition?(this.overlay.style.left="50%",this.overlay.style.transform="translateX(-50%)",this.overlay.style.bottom="120px"):(this.overlay.style.left=`${this.position.left}px`,this.overlay.style.bottom=`${this.position.bottom}px`,this.overlay.style.transform=""))}savePosition(){chrome.storage.sync.set({position:this.position})}handleMouseDown(t){const e=t.target;if("BUTTON"!==e.tagName&&"yt-live-translate-original"!==e.id&&"yt-live-translate-translated"!==e.id){if(t.preventDefault(),t.stopPropagation(),this.useDefaultPosition&&this.overlay?.parentElement){const t=this.overlay.parentElement.getBoundingClientRect(),e=this.overlay.getBoundingClientRect();this.position={left:e.left-t.left,bottom:t.bottom-e.bottom},this.useDefaultPosition=!1,this.updateOverlayPosition()}if(console.log("[YouTube Live Translate] 开始拖拽"),this.isDragging=!0,this.overlay){const e=this.overlay.getBoundingClientRect();this.dragOffsetX=t.clientX-e.left,this.dragOffsetY=e.bottom-t.clientY}this.subtitleBox&&(this.subtitleBox.style.cursor="grabbing"),document.addEventListener("mousemove",this.handleMouseMove),document.addEventListener("mouseup",this.handleMouseUp)}}updateOriginalVisibility(){this.originalLine&&(this.originalLine.style.display=this.state.showOriginal?"-webkit-box":"none")}updateTextAlign(){this.originalLine&&(this.originalLine.style.textAlign=this.state.textAlign),this.translatedLine&&(this.translatedLine.style.textAlign=this.state.textAlign)}updateTranslatedFontSize(){this.translatedLine&&(this.translatedLine.style.fontSize=`${i[this.state.translatedFontSize]}px`)}updateOriginalSubtitlesVisibility(){const t=()=>{[".ytp-caption-segment","caption-window.ytp-caption-window-bottom",".captions-text",".ytp-caption-window-container"].forEach(t=>{document.querySelectorAll(t).forEach(t=>{this.state.hideOriginalSubtitles?(t.style.opacity="0",t.style.visibility="hidden"):(t.style.opacity="",t.style.visibility="")})});const t=document.querySelector("#movie_player")||document.querySelector("ytd-player");t&&t.querySelectorAll(".caption-visual-line").forEach(t=>{this.state.hideOriginalSubtitles?t.style.display="none":t.style.display=""})};t(),this.state.hideOriginalSubtitles?(this.subtitleObserver&&this.subtitleObserver.disconnect(),this.subtitleObserver=new MutationObserver(()=>{t()}),this.subtitleObserver.observe(document.body,{childList:!0,subtree:!0})):this.subtitleObserver&&(this.subtitleObserver.disconnect(),this.subtitleObserver=null)}startWatchingSubtitles(){console.log("[YouTube Live Translate] 开始监听字幕...");const t=[".ytp-caption-segment","caption-window.ytp-caption-window-bottom",".captions-text",".ytp-caption-window-container .caption-visual-line",".ytp-caption-window-container span"],e=()=>{for(const e of t){const t=document.querySelectorAll(e);if(t.length>0){let i=!1;if(t.forEach(t=>{t.textContent?.trim()&&(i=!0)}),i)return console.log(`[YouTube Live Translate] 找到字幕元素: ${e} (数量: ${t.length})`),void this.observeSubtitles(e);console.log(`[YouTube Live Translate] 跳过无文本的选择器: ${e}`)}}setTimeout(e,1e3)};e()}observeSubtitles(t){this.observer=new MutationObserver(()=>{this.handleSubtitleChange(t)});const e=document.body;this.observer.observe(e,{childList:!0,subtree:!0}),this.checkInterval=window.setInterval(()=>{this.handleSubtitleChange(t)},120),console.log("[YouTube Live Translate] 开始监听字幕变化")}truncateBySentences(t,e){if(t.length<=e)return t;const i=t.split(/(?<=[.!?])\s+|\n+/).map(t=>t.trim()).filter(Boolean);if(0===i.length)return this.truncateByWords(t,e);let s="";for(let t=i.length-1;t>=0;t--){const n=s?i[t]+" "+s:i[t];if(!(n.length<=e)){if(s)break;s=this.truncateByWords(i[t],e);break}s=n}return s||this.truncateByWords(t,e)}truncateByWords(t,e){if(t.length<=e)return t;const i=t.slice(-e),s=i.indexOf(" ");return s>0&&s<i.length-1?i.slice(s+1).trim():i}handleSubtitleChange(t){if(!this.state.enabled||this.isVideoPaused||this.isAdPlaying)return;const e=Date.now();if(e-this.lastProcessTime<this.THROTTLE_DELAY)return;const i=document.querySelectorAll(t);if(0===i.length)return void(this.lastValidSubtitleTime>0&&e-this.lastValidSubtitleTime>this.SUBTITLE_TIMEOUT&&(console.log("[YouTube Live Translate] 字幕元素消失超时，清理翻译控件"),this.clearSubtitle(),this.lastValidSubtitleTime=0));let s="";if(i.forEach(t=>{const e=t.textContent?.trim();e&&(s+=(s?" ":"")+e)}),!s)return console.log(`[YouTube Live Translate] ⚠️ 找到元素但文本为空 (selector: ${t}, elements: ${i.length})`),i.length>0&&console.log("[YouTube Live Translate] 元素 HTML:",i[0].outerHTML.substring(0,200)),void(this.lastValidSubtitleTime>0&&e-this.lastValidSubtitleTime>this.SUBTITLE_TIMEOUT&&(console.log("[YouTube Live Translate] 字幕文本为空超时，清理翻译控件"),this.clearSubtitle(),this.lastValidSubtitleTime=0));if(console.log(`[YouTube Live Translate] 字幕变化: "${s.substring(0,50)}${s.length>50?"...":""}"`),this.lastValidSubtitleTime=e,s===this.lastOriginalText)return;const n=""===this.lastOriginalText,a=!n&&s.length<this.lastOriginalText.length;let l=s,o=!1,r=!1;if(n?(l=s.length>200?this.truncateBySentences(s,200):s,o=!0,r=s.length>200,console.log("[YouTube Live Translate] 首次内容，刷新UI并触发翻译")):a?(l=s,o=!0,this.lastTranslatedText="",console.log("[YouTube Live Translate] 新句子，刷新UI")):s.length>200?(l=this.truncateBySentences(s,200),o=!0,r=!0,console.log("[YouTube Live Translate] 文本过长，按整句截断并立即翻译")):s.includes(this.lastOriginalText)?(l=s,o=!1,console.log("[YouTube Live Translate] 追加文本，不刷新UI")):(l=s,o=!0,console.log("[YouTube Live Translate] 内容不同，刷新UI")),(l!==this.lastOriginalText||o)&&(this.lastOriginalText=l,this.lastProcessTime=e,o)){if(this.originalLine&&(this.originalLine.textContent=this.lastOriginalText),this.overlay&&!this.isClosed){this.overlay.style.display="block",this.overlay.style.opacity="1";const t=this.translatedLine?.textContent?.trim();t||this.showLoading()}if(r)l!==this.lastTranslatedText?(console.log("[YouTube Live Translate] 立即触发翻译"),this.lastTranslatedText=l,this.requestTranslation(l)):console.log("[YouTube Live Translate] 文本已翻译过，跳过");else{this.debounceTimer&&clearTimeout(this.debounceTimer);const t=this.lastOriginalText;this.debounceTimer=window.setTimeout(()=>{t===this.lastOriginalText&&(console.log("[YouTube Live Translate] 字幕稳定，触发翻译"),this.requestTranslation(t))},this.DEBOUNCE_DELAY)}}}async requestTranslation(t){this.seq++;const e=this.seq;this.latestSeq=e,console.log(`[YouTube Live Translate] 请求翻译 [seq=${e}]:`,t);const i=this.cache.get("auto",this.state.targetLang,t);if(i)return console.log(`[YouTube Live Translate] 命中缓存 [seq=${e}]`),void this.updateTranslation(t,i,e);if(this.translationQueue.has(t))return void console.log(`[YouTube Live Translate] 已在翻译队列中 [seq=${e}]`);const s=Date.now(),n=this.currentSubtitle?.timestamp||0;if(s-n<this.TRANSLATION_INTERVAL){const e=this.TRANSLATION_INTERVAL-(s-n);return void setTimeout(()=>{this.requestTranslation(t)},e)}this.translationQueue.add(t);try{const i=await this.translateText(t);this.translationQueue.delete(t),this.cache.set("auto",this.state.targetLang,t,i),e===this.latestSeq?(console.log(`[YouTube Live Translate] 翻译完成 [seq=${e}]:`,i),this.updateTranslation(t,i,e)):console.log(`[YouTube Live Translate] 丢弃过期翻译 [seq=${e}, latest=${this.latestSeq}]`)}catch(i){console.error(`[YouTube Live Translate] 翻译失败 [seq=${e}]:`,i),this.translationQueue.delete(t)}}async translateText(t){const e=`https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${this.state.targetLang}&dt=t&q=${encodeURIComponent(t)}`,i=await fetch(e);if(!i.ok)throw new Error(`翻译请求失败: ${i.status} ${i.statusText}`);const s=await i.json();if(s&&Array.isArray(s[0])){const e=s[0].map(t=>t&&Array.isArray(t)?t[0]:null).filter(t=>null!=t&&"string"==typeof t);return e.length>0?e.join(""):t}return t}updateTranslation(t,e,s){if(!this.translatedLine||!this.subtitleBox)return;this.currentSubtitle={original:t,translated:e,timestamp:Date.now(),seq:s},this.lastTranslatedText=t,this.hideLoading(),this.translatedLine.textContent=e;const n=i[this.state.translatedFontSize];this.translatedLine.style.fontSize=`${n}px`,this.fitTranslatedFontSizeToBox(),this.overlay&&!this.isClosed&&(this.overlay.style.display="block",this.overlay.style.opacity="1"),console.log("[YouTube Live Translate] 译文已更新")}fitTranslatedFontSizeToBox(){if(!this.translatedLine||!this.subtitleBox)return;const t=this.subtitleBox;let e=parseInt(this.translatedLine.style.fontSize||"22",10)||22;for(;e>=12&&t.scrollHeight>t.clientHeight;)e-=2,this.translatedLine.style.fontSize=`${e}px`}clearSubtitle(){this.lastOriginalText="",this.debounceTimer&&(clearTimeout(this.debounceTimer),this.debounceTimer=null),this.hideLoading(),this.overlay&&(this.overlay.style.display="none"),this.originalLine&&(this.originalLine.textContent=""),this.translatedLine&&(this.translatedLine.textContent="")}toggleTranslation(){this.state.enabled||(this.debounceTimer&&(clearTimeout(this.debounceTimer),this.debounceTimer=null),this.clearSubtitle(),this.cache.clear(),this.translationQueue.clear(),this.overlay&&(this.overlay.style.display="none"))}}r.MAX_OVERLAY_ATTEMPTS=15,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{new r}):new r})();